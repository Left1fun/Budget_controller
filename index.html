<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—é–¥–∂–µ—Ç–Ω—ã–π –Ω–∞–¥–∑–∏—Ä–∞—Ç–µ–ª—å</title>
    <link href="https:
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="avatar.png">
</head>
<body>
    <div class="container">
        <h1>üí∞ –ë—é–¥–∂–µ—Ç–Ω—ã–π –Ω–∞–¥–∑–∏—Ä–∞—Ç–µ–ª—å</h1>
        <div class="card">
            <div class="start-card">
                <h2>–í–∞—à –±—é–¥–∂–µ—Ç</h2>
                <button class="resetAll" onclick="resetAll()">–û–±–Ω—É–ª–∏—Ç—å—Å—è</button>
            </div>
            <p id="limitPeriodLabel">–õ–∏–º–∏—Ç: <span id="currentLimit">0</span> ‚ÇΩ</p>
            <p>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: <span id="totalSpent">0</span> ‚ÇΩ</p>
            <p>–û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining">0</span> ‚ÇΩ</p>
            <div id="forecastInfo">
                <div id="limitEndInfo" class="info-alert" style="display: none"></div>
                <div id="nextIncomeInfo" class="info-alert" style="display: none; margin-top: 10px"></div>
            </div>
        </div>

        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–º–∏—Ç–∞</h2>
            <select id="limitPeriod">
                <option value="day">–î–µ–Ω—å</option>
                <option value="week">–ù–µ–¥–µ–ª—è</option>
                <option value="month">–ú–µ—Å—è—Ü</option>
                <option value="year">–ì–æ–¥</option>
                <option value="forever">–í–µ—á–Ω—ã–π</option>
            </select>
            <input type="number" id="monthlyLimit" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
            <button onclick="setLimit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏–º–∏—Ç</button>
            <button onclick="resetLimit()" style="margin-top: 10px; background: #ff5252">–û–±–Ω—É–ª–∏—Ç—å –ª–∏–º–∏—Ç</button>
        </div>

        <div class="card">
            <h2>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h2>
            <select id="incomeInterval">
                <option value="day">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                <option value="week">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                <option value="month" selected>–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                <option value="year">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
            </select>
            <input type="number" id="regularIncomeAmount" placeholder="–°—É–º–º–∞">
            <button onclick="addRegularIncome()">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –¥–æ—Ö–æ–¥</button>
        </div>

        <div class="card">
            <h2>–ù–æ–≤—ã–π —á–µ–∫</h2>
            <div id="checkItems">
                <div class="check-item">
                    <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="item-name">
                    <input type="number" placeholder="–°—É–º–º–∞" class="item-amount">
                </div>
            </div>
            
            <p style="margin: 10px 0">–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Å—É–º–º–∞: <strong><span id="checkTotal">0</span> ‚ÇΩ</strong></p>
            <button onclick="addMoreItems()" style="margin-top: 10px;">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ç–æ–≤–∞—Ä</button>
            <button onclick="saveCheck()" style="margin-top: 10px; background: #00c853">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ–∫</button>
        </div>
        <div class="card">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h2>
            <input type="text" id="incomeDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            <input type="number" id="incomeAmount" placeholder="–°—É–º–º–∞">
            <button onclick="addIncome()" style="background: #00c853">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
        </div>
        
        <div class="card">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            <button onclick="clearHistory()" style="margin-bottom: 10px; background: #ff5252">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é</button>
            <ul id="expenseList"></ul>
        </div>
    </div>

    <script>
let monthlyLimit = 0;
let totalSpent = 0;
let expenses = [];
let regularIncomes = [];
let limitSettings = {
    period: 'month',
    lastReset: Date.now()
};
let currentCheckItems = [];
let checkTotal = 0;
let incomeCheckInterval;

function checkRegularIncomes() {
    const now = Date.now();
    let needsUpdate = false;
    regularIncomes.forEach(income => {
        let nextDate = calculateNextIncomeDate(income);
        while(now >= nextDate) {
            monthlyLimit += income.amount;
            income.lastApplied = nextDate;
            nextDate = calculateNextIncomeDate(income);
            needsUpdate = true;
        }
    });
    if(needsUpdate) {
        saveData();
        updateUI();
    }
}
function clearHistory() {
    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π?")) {
        expenses = [];
        saveData();
        updateUI();
    }
}
function resetAll() {
    if(confirm("–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?")) {
        monthlyLimit = 0;
        totalSpent = 0;
        expenses = [];
        regularIncomes = [];
        limitSettings.lastReset = Date.now();
        saveData();
        updateUI();
    }
}
function addIncome() {
    const description = document.getElementById('incomeDescription').value.trim();
    const amount = parseFloat(document.getElementById('incomeAmount').value);
    
    if (!description || isNaN(amount)) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
        return;
    }
    
    expenses.push({
        type: 'income',
        description: description,
        amount: amount,
        date: new Date().toLocaleString()
    });
    
    monthlyLimit += amount;
    saveData();
    updateUI();
    document.getElementById('incomeDescription').value = '';
    document.getElementById('incomeAmount').value = '';
}

function addMoreItems() {
    const checkItems = document.getElementById('checkItems');
    const newItem = document.createElement('div');
    newItem.className = 'check-item';
    newItem.innerHTML = `
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="item-name">
        <input type="number" placeholder="–°—É–º–º–∞" class="item-amount">
    `;
    checkItems.appendChild(newItem);
    
    newItem.querySelector('.item-amount').addEventListener('input', calculateCheckTotal);
};

function saveCheck() {
    const items = Array.from(document.getElementsByClassName('check-item'));
    const checkContents = [];
    let total = 0;
    
    items.forEach(item => {
        const name = item.querySelector('.item-name').value.trim();
        const amount = parseFloat(item.querySelector('.item-amount').value);
        
        if (name && !isNaN(amount)) {
            checkContents.push({ name, amount });
            total += amount;
        }
    });
    
    if (checkContents.length === 0) {
        alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!");
        return;
    }
    
    expenses.push({
        type: 'check',
        total: total,
        items: checkContents,
        date: new Date().toLocaleString()
    });
    
    totalSpent += total;
    saveData();
    updateUI();
    clearCheckForm();
};

function clearCheckForm() {
    const checkItems = document.getElementById('checkItems');
    checkItems.innerHTML = '<div class="check-item"><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="item-name"><input type="number" placeholder="–°—É–º–º–∞" class="item-amount"></div>';
};

function calculateCheckTotal() {
    const items = Array.from(document.getElementsByClassName('check-item'));
    let total = 0;
    items.forEach(item => {
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += amount;
    });
    document.getElementById('checkTotal').textContent = total.toFixed(2);
}

function loadData() {
    const savedData = localStorage.getItem('budgetData');
    if (savedData) {
        const data = JSON.parse(savedData);
        monthlyLimit = data.limit || 0;
        totalSpent = data.spent || 0;
        expenses = data.expenses || [];
        regularIncomes = data.regularIncomes || [];
        limitSettings = data.limitSettings || {
            period: 'month',
            lastReset: Date.now()
        };
    }
    checkLimitReset();
    updateUI();
}

function saveData() {
    const data = {
        limit: monthlyLimit,
        spent: totalSpent,
        expenses: expenses,
        regularIncomes: regularIncomes,
        limitSettings: limitSettings
    };
    localStorage.setItem('budgetData', JSON.stringify(data));
}

function checkLimitReset() {
    if (limitSettings.period === 'forever') return; 

    const now = Date.now();
    const lastReset = limitSettings.lastReset;
    const period = limitSettings.period;
    let reset = false;

    const lastDate = new Date(lastReset);
    const currentDate = new Date(now);

    switch(period) {
        case 'day':
            reset = !isSameDay(lastDate, currentDate);
            break;
        case 'week':
            reset = !isSameWeek(lastDate, currentDate);
            break;
        case 'month':
            reset = !isSameMonth(lastDate, currentDate);
            break;
        case 'year':
            reset = !isSameYear(lastDate, currentDate);
            break;
    }

    if(reset) {
        monthlyLimit = 0;
        totalSpent = 0;
        expenses = [];
        limitSettings.lastReset = now;
        saveData();
    }
}

function isSameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
}

function isSameWeek(d1, d2) {
    const oneDay = 86400000;
    const diffDays = Math.round((d2 - d1) / oneDay);
    return diffDays < 7 && d1.getDay() === d2.getDay();
}

function isSameMonth(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() && 
           d1.getMonth() === d2.getMonth();
}

function isSameYear(d1, d2) {
    return d1.getFullYear() === d2.getFullYear();
}

function calculateTimeLeft(targetDate) {
    const now = Date.now();
    const diff = targetDate - now;
    if(diff <= 0) return null;

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    return {days, hours, minutes};
}

function setLimit() {
    monthlyLimit = parseFloat(document.getElementById('monthlyLimit').value);
    limitSettings.period = document.getElementById('limitPeriod').value;
    
    
    if (limitSettings.period !== 'forever') {
        limitSettings.lastReset = new Date().getTime();
    }
    
    if (!monthlyLimit || isNaN(monthlyLimit)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
        return;
    }
    
    saveData();
    updateUI();
    document.getElementById('monthlyLimit').value = '';
}
function resetLimit() {
    monthlyLimit = 0;
    totalSpent = 0;
    expenses = [];
    limitSettings.lastReset = new Date().getTime();
    saveData();
    updateUI();
}
function addRegularIncome() {
    const amount = parseFloat(document.getElementById('regularIncomeAmount').value);
    const interval = document.getElementById('incomeInterval').value;
    if (!amount || isNaN(amount)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
        return;
    }
    regularIncomes.push({
        amount: amount,
        interval: interval,
        lastApplied: new Date().getTime()
    });
    saveData();
    updateUI();
    document.getElementById('regularIncomeAmount').value = '';
}
function addExpense() {
    const name = document.getElementById('expenseName').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    if (!name || isNaN(amount)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
        return;
    }
    expenses.push({ name, amount });
    totalSpent += amount;
    saveData();
    updateUI();
    giveFeedback();
    
    document.getElementById('expenseName').value = '';
    document.getElementById('expenseAmount').value = '';
}
function updateUI() {
    document.getElementById('currentLimit').textContent = monthlyLimit;
    document.getElementById('totalSpent').textContent = totalSpent;
    document.getElementById('remaining').textContent = monthlyLimit - totalSpent;
    const periodNames = {
        day: '–î–Ω–µ–≤–Ω–æ–π',
        week: '–ù–µ–¥–µ–ª—å–Ω—ã–π',
        month: '–ú–µ—Å—è—á–Ω—ã–π',
        year: '–ì–æ–¥–æ–≤–æ–π',
        forever: '–í–µ—á–Ω—ã–π' 
    };
    const limitPeriodElement = document.getElementById('limitPeriodLabel');
    if (limitPeriodElement) {
        limitPeriodElement.innerHTML = 
            `–õ–∏–º–∏—Ç (${periodNames[limitSettings.period]}): <span id="currentLimit">${monthlyLimit}</span> ‚ÇΩ`;
    }
    const expenseList = document.getElementById('expenseList');
    expenseList.innerHTML = expenses.map((exp, index) => {
        let content = '';
        if (exp.type === 'check') {
            content = `
                <li>
                    <div class="check-header">
                        <span>–ß–µ–∫: ${exp.total} ‚ÇΩ</span>
                        <small>(${exp.date})</small>
                        <button onclick="deleteEntry(${index})" class="delete-btn">√ó</button>
                    </div>
                    <ul class="check-details">
                        ${exp.items.map(item => `<li>${item.name}: ${item.amount} ‚ÇΩ</li>`).join('')}
                    </ul>
                </li>`;
        } else if (exp.type === 'income') {
            content = `
                <li style="border-color: #00c853">
                    <span>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ: ${exp.description} (+${exp.amount} ‚ÇΩ)</span>
                    <small>(${exp.date})</small>
                    <button onclick="deleteEntry(${index})" class="delete-btn">√ó</button>
                </li>`;
        } else {
            content = `
                <li>
                    <span>${exp.name}: ${exp.amount} ‚ÇΩ</span>
                    <button onclick="deleteEntry(${index})" class="delete-btn">√ó</button>
                </li>`;
        }
        return content;
    }).join('');
    updateForecastInfo();
}
function giveFeedback() {
    const feedback = document.getElementById('feedback');
    const remaining = monthlyLimit - totalSpent;
    if (totalSpent > monthlyLimit) {
        feedback.className = 'warning';
        feedback.innerHTML = '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞! –°—Ä–æ—á–Ω–æ —ç–∫–æ–Ω–æ–º—å—Ç–µ!';
    } else if (remaining < monthlyLimit * 0.2) {
        feedback.className = 'warning';
        feedback.innerHTML = '–û—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –¥–µ–Ω–µ–≥! –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã.';
    } else {
        feedback.className = 'success';
        feedback.innerHTML = '–í—ã –≤ —Ä–∞–º–∫–∞—Ö –±—é–¥–∂–µ—Ç–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!';
        
        if (remaining > 0) {
            feedback.innerHTML += `<br>–ú–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –µ—â—ë ${remaining} ‚ÇΩ.`;
        }
    }
}
function deleteEntry(index) {
    const entry = expenses[index];
    if(entry.type === 'income') {
        monthlyLimit -= entry.amount;
    } else if(entry.type === 'check') {
        totalSpent -= entry.total;
    }
    expenses.splice(index, 1);
    saveData();
    updateUI();
}
function calculateLimitEndDate() {
    if (monthlyLimit === 0 || totalSpent >= monthlyLimit) return null;
    
    const periodMilliseconds = {
        day: 86400000,
        week: 604800000,
        month: 2592000000, 
        year: 31536000000
    }[limitSettings.period];
    const timeSinceReset = Date.now() - limitSettings.lastReset;
    const averageDaily = (totalSpent / timeSinceReset) * 86400000;
    
    if (averageDaily <= 0) return null;
    const remaining = monthlyLimit - totalSpent;
    const daysLeft = Math.floor(remaining / averageDaily);
    return daysLeft > 0 ? new Date(Date.now() + daysLeft * 86400000) : null;
}
function formatDate(date) {
    return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}
function calculateNextIncomeDate(income) {
    let nextDate = new Date(income.lastApplied);
    switch(income.interval) {
        case 'day': 
            nextDate.setDate(nextDate.getDate() + 1);
            break;
        case 'week': 
            nextDate.setDate(nextDate.getDate() + 7);
            break;
        case 'month': 
            nextDate.setMonth(nextDate.getMonth() + 1);
            break;
        case 'year': 
            nextDate.setFullYear(nextDate.getFullYear() + 1);
            break;
    }
    return nextDate.getTime();
}

function updateForecastInfo() {
    checkRegularIncomes();
    const limitEndInfo = document.getElementById('limitEndInfo');
    const nextIncomeInfo = document.getElementById('nextIncomeInfo');
    
    limitEndInfo.style.display = monthlyLimit > 0 ? 'block' : 'none';
    nextIncomeInfo.style.display = regularIncomes.length > 0 ? 'block' : 'none';
    

    if (limitSettings.period === 'forever') {
        limitEndInfo.innerHTML = '‚àû –õ–∏–º–∏—Ç –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ –≤—Ä–µ–º–µ–Ω–∏';
        return;
    }
    if(monthlyLimit === 0) {
        limitEndInfo.innerHTML = '‚ö† –õ–∏–º–∏—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
        nextIncomeInfo.innerHTML = '';
        return;
    }
    
    if(totalSpent >= monthlyLimit) {
        limitEndInfo.innerHTML = '‚ö† –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω!';
        nextIncomeInfo.innerHTML = '';
        return;
    }
    
    const nextIncome = getNextIncome();
    if(nextIncome) {
        const timeLeft = calculateTimeLeft(nextIncome.date);
        if(timeLeft) {
            let timeString = [];
            if(timeLeft.days > 0) timeString.push(`${timeLeft.days}–¥`);
            if(timeLeft.hours > 0) timeString.push(`${timeLeft.hours}—á`);
            timeString.push(`${timeLeft.minutes}–º`);
            
            nextIncomeInfo.innerHTML = `‚è≥ –°–ª–µ–¥. –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑: ${timeString.join(' ')}`;
        } else {
            nextIncomeInfo.innerHTML = '‚úÖ –°—Ä–µ–¥—Å—Ç–≤–∞ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã';
        }
    } else {
        nextIncomeInfo.innerHTML = regularIncomes.length > 0 
            ? '‚Ñπ –†–∞—Å—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...' 
            : '‚Ñπ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π';
    }
    
    const endDate = getLimitEndTime();
    if(endDate) {
        const timeLeft = calculateTimeLeft(endDate);
        if(timeLeft) {
            let timeString = [];
            if(timeLeft.days > 0) timeString.push(`${timeLeft.days}–¥`);
            if(timeLeft.hours > 0) timeString.push(`${timeLeft.hours}—á`);
            timeString.push(`${timeLeft.minutes}–º`);
            
            limitEndInfo.innerHTML = `‚è≥ –õ–∏–º–∏—Ç –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —á–µ—Ä–µ–∑: ${timeString.join(' ')}`;
        } else {
            limitEndInfo.innerHTML = '‚Ñπ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞';
        }
    } else {
        limitEndInfo.innerHTML = '‚Ñπ –ù–∞—á–Ω–∏—Ç–µ —Ç—Ä–∞—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞';
    }
}


function getLimitEndTime() {
    if (limitSettings.period === 'forever') return null; 
    
    if(monthlyLimit === 0) return null;
    
    const periodMs = {
        day: 86400000,
        week: 604800000,
        month: 2592000000,
        year: 31536000000
    }[limitSettings.period];

    const timePassed = Date.now() - limitSettings.lastReset;
    const spentPerMs = totalSpent / timePassed;
    
    
    if(spentPerMs <= 0) return null;
    
    const remaining = monthlyLimit - totalSpent;
    return Date.now() + (remaining / spentPerMs);
}

function getNextIncome() {
    let nearestIncome = null;
    
    regularIncomes.forEach(income => {
        const nextDate = calculateNextIncomeDate(income);
        if(!nearestIncome || nextDate < nearestIncome.date) {
            nearestIncome = {
                date: nextDate,
                amount: income.amount
            };
        }
    });
    
    return nearestIncome;
}
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    updateForecastInfo();
    
    setInterval(() => {
        updateForecastInfo();
    }, 6000);
});
    </script>
</body>
</html>
